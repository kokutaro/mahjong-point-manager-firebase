# 詳細ゲームルール設計書 (Game Rules Design)

本ドキュメントでは、親番移動、連荘、供託、本場、およびゲーム終了判定に関する詳細ルールを定義します。
実装時のロジック（`gameLogic.ts`）およびテストケースはこの仕様に基づきます。

## 1. 局の進行と親番移動 (Dealer & Round Rotation)

### 1.1. 局の遷移フロー
以下のイベント発生時に局の遷移判定を行う。
1. **和了 (Win)**: ロンまたはツモによるアガリ。
2. **流局 (Ryukyoku)**: 荒牌平局（山がなくなる）、または途中流局（九種九牌等）。

### 1.2. 連荘 (Renchan) 条件
親（Dealer）が以下のいずれかの条件を満たした場合、親は交代せず、同じ局が継続する（**連荘**）。
*   **親のアガリ**: 親が和了した場合（ダブロンで親が含まれる場合も含む）。
*   **親のテンパイ (流局時)**: 流局時に親が聴牌（テンパイ）していた場合。
    *   ※設定により「ノーテン親流れ」「テンパイ連荘」を変更可能とするが、デフォルトは「テンパイ連荘」。

### 1.3. 親流れ (Dealer Rotation) 条件
以下の条件の場合、親が下家に移動し、次局へ遷移する。
*   **子の単独アガリ**: 親が含まれないアガリ。
*   **親のノーテン (流局時)**: 流局時に親が不聴（ノーテン）だった場合。

### 1.4. 局番号と場風 (Wind Rotation)
*   **連荘時**:
    *   局番号（`round.number`）: 変化なし (例: 東1局 → 東1局)
    *   本場（`round.honba`）: +1 加算
*   **親流れ時**:
    *   局番号: +1 加算 (例: 東1局 → 東2局)
    *   **子の和了時**: 本場は 0 にリセット。
    *   **流局時 (親ノーテン)**: 本場は **+1 加算** (リセットしない)。
*   **場風遷移 (Round Wind)**:
    *   4人麻雀: 東4局終了時、次が西入でなければ「南1局」へ。南4局終了時、条件を満たしていなければ「西1局」へ（設定による）。
    *   3人麻雀: 東3局終了時、「南1局」へ。

---

## 2. 本場 (Honba) 管理

### 2.1. 本場の加算
*   **連荘時**: 現在の本場数 + 1。
*   **流局時**: 現在の本場数 + 1 (親が流れるかどうかに関わらず、本場は積まれる)。

### 2.2. 本場の解消
*   **子の和了時**: 0 にリセットされる。
*   **親の和了時**: 本場は維持されず、加算される（連荘扱い）。
    *   *Correction*: 親のアガリでも本場数字自体は増える（1本場→2本場）。「解消」されるのは「誰かが（親以外が、または親が上がっても局が変わる場合）」という概念だが、正確には「局遷移時に0になるか、+1になるか」で定義済。

### 2.3. 本場点（積み棒点）の授受
*   1本場につき、和了者に対して点数が加算される。
*   **計算式**: `本場数 * 点数設定` (通常: 300点/本 or 1500点/本[3麻])。
*   **ツモ時**: 全員で分担（支払う合計は `本場数 * 300`）。
*   **ロン時**: 放銃者が全額支払い。
*   **複数和了 (Multi-Win) 時**:
    *   **頭跳ね (Head Bump)**: 上家（放銃者から見てツモ巡が早い順）の和了者1名のみが本場点を受け取る。
    *   *要件定義上の設定*: 基本は頭跳ねを採用。

---

## 3. 供託 (Riichi Sticks) 管理

### 3.1. 供託の発生
*   プレイヤーがリーチを宣言した際、1000点を供託として場に出す。

### 3.2. 供託の取得
*   **和了時**: 和了者が場にある全ての供託（リーチ棒）を取得する。
*   **流局時**: 供託は次局へ持ち越される。

### 3.3. 複数和了時の供託取得
*   **頭跳ね (Head Bump)**: 本場点と同様、放銃者に最も近い（上家の）和了者が総取りする。

---

## 4. ゲーム終了判定 (Game End)

### 4.1. トビ (Bankruptcy)
*   いずれかのプレイヤーの持ち点が0点未満（設定により0点以下も可）になった時点で、即座にゲーム終了。

### 4.2. オーラス終了 (All Last End)
*   **南4局（3麻は南3局）終了時**:
    *   トップの点数が基準点（例: 30000点）以上の場合: ゲーム終了。
    *   基準点未満の場合: 西入（あるいは北入）。
*   **アガリ止め**:
    *   オーラスでトップの親がアガリ、かつ基準点を超えている場合、親の判断でゲームを終了できる（設定により自動終了）。

---

## 5. データ構造定義 (TypeScript Inteface Draft)

```typescript
interface GameState {
  players: Player[];
  round: {
    wind: 'East' | 'South' | 'West' | 'North';
    number: number; // 1~4
    honba: number;
    riichiSticks: number;
    isAllLast: boolean; // オーラス判定用フラグ
  };
  settings: GameSettings;
}

interface EndHandResult {
  nextRound: {
    wind: 'East' | 'South' | 'West' | 'North';
    number: number;
    honba: number;
    riichiSticks: number;
  };
  isGameOver: boolean;
  gameEndReason?: 'Bankruptcy' | 'ScoreReached' | 'MaxRoundReached';
}

// Logic Function Signature
// アガリ/流局情報を受け取り、次の局の状態を返す
function processHandEnd(
  currentState: GameState,
  result: {
    type: 'Win' | 'Draw';
    winners?: string[]; // Winの場合。複数可
    loser?: string;       // Ronの場合
    tenpaiPlayerIds?: string[]; // Drawの場合
  }
): EndHandResult;
```
