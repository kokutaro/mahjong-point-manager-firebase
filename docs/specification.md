# 麻雀点数管理アプリ 仕様書

## 1. 概要

本ドキュメントは、Webブラウザ上で動作する麻雀点数管理アプリケーションの要件および仕様を定義するものである。
参加者全員が自身のスマートフォンで操作する「同期モード」と、1台の端末で管理する「単独モード」の両方に対応し、ゲーム進行を阻害しないスムーズなUXを提供することを目的とする。

## 2. 基本要件

- **プラットフォーム**: Webアプリケーション (モバイルブラウザ推奨)
- **対応ルール**:
  - 4人麻雀 (4麻)
  - 3人麻雀 (3麻)
- **言語**: 日本語

## 3. モード仕様
### 3.0 計算モード
- **符計算あり (通常)**: 従来通りの符計算を行う。
- **符計算なし (簡易)**: 符計算を省略し、1-3翻は固定点数、4翻以上は満貫以上とする。
  - 1-3翻の固定点数:
    - 子: 1000, 2000, 4000
    - 親: 1500, 3000, 6000

### 3.1 同期モード (マルチデバイス)

- **概要**: 参加者全員が各自のスマートフォンでアプリを開き、リアルタイムに点数状況を共有・操作する。
- **通信方式**: WebSocket等を用いたリアルタイム通信。
- **機能**:
  - 全員が現在の点棒状況、場、供託などをリアルタイムに確認可能。
  - 誰かが点数移動操作を行うと、全端末に即座に反映される。
  - 部屋(ルーム)作成と招待の仕組みが必要。

### 3.2 単独モード (シングルデバイス)

- **概要**: 1人のプレイヤー(または記録係)が1台のスマートフォンで卓全体の点数を管理する。
- **機能**:
  - 1画面(または切り替え)で全プレイヤーの点数を表示・操作可能。
  - 通信環境がない場所でも動作可能な設計(オフライン動作も視野)。

## 4. ゲーム進行管理機能

ゲームのテンポを損なわないよう、以下の項目を自動化または簡易操作化する。

### 4.1 場・親管理

- 東場/南場/西場(ローカル)の管理。
- 親番の表示と管理。
- **自動ローテーション**:
  - 親のアガリ時は連荘。
  - 子のアガリ時は親流れ。
  - 流局時のテンパイ/ノーテンによる親流れ/連荘の判定(設定により変更可能に対応)。

### 4.2 特殊点棒・状況管理

- **チップ管理**:
  - **有無設定**: ゲーム開始時にチップの有無を選択可能。
  - **やり取り**: 点数計算時にチップ枚数の変動を入力・表示可能。
  - アガリ時だけでなく、一発・赤・裏ドラ等に伴うチップ精算に対応。
- **本場(積み棒)**: 流局時や連荘時に自動/手動で加算。アガリ時に点数計算に自動反映。
- **供託(リーチ棒)**:
  - リーチ宣言時に1000点減算＆供託へ移動。
  - アガリ時に供託を勝者が総取り。
  - 流局時の供託持ち越し。
- **トビ判定**: 点数が0未満(または設定値以下)になった場合のゲーム終了判定。箱下計算の有無も考慮。
- **特殊流局**: 九種九牌、四風連打等の途中流局対応。
- **複数人ロン (ダブロン・トリプルロン)**:
  - **ダブロン**: 基本的に有効とし、両者に点数を支払う。
  - **トリプルロン**:
    - 設定により「流局(三家和)」か「有効」かを選択可能にする。
  - **供託・積み棒の扱い**:
    - 上家取り(頭跳ね)等のルールを設定可能にする。(例: 放銃者から見てアガリ巡目が最も早いプレイヤーが供託・積み棒を取得)

## 5. 点数計算・移動フロー

アガリが発生した際の操作フローを以下のように定義し、手数を最小限にする。

1. **アガリ種別選択**: 「ロン」または「ツモ」を選択。
2. **放銃者選択** (ロンの場合): 放銃したプレイヤーを選択。
3. **飜数・符数選択**:
    - 例: 「4飜」「30符」などをボタン選択。
    - または「満貫」「跳満」などの直接選択も可能にする。
    - **符計算なしモード時**:
      - 1~3翻を選択時は符選択をスキップし、固定点数を適用。
      - 満貫以上の選択は通常通り。
4. **点数確認**: 計算された支払い点数を表示(本場・供託含む)。
5. **確定・支払い**: 確定ボタンで点数移動実行。

## 6. UI/UX要件

- **視認性**: 点数状況がひと目で分かる大きな表示。
- **操作性**: 片手で操作しやすいボタン配置。誤操作時の「元に戻す(Undo)」機能。
- **カスタマイズ性**:
  - 3麻/4麻の切り替え。
  - ウマ・オカの設定。
  - 飛び賞、焼き鳥などのオプション設定(将来拡張)。
- **トップページ**:
  - 現在対局中であり、自身が所属しているルームがある場合、トップページから容易に再参加(Re-join)できる導線を設ける。

## 7. 技術スタック案 (参考)

- **Frontend**: React / Vue.js / Next.js
- **Realtime**: WebSocket / Socket.io / Firestore / Supabase Realtime
- **Backend (Optional)**: Node.js (for WebSocket server) or Serverless functions

## 8. 拡張機能要件

### 8.1 連続対局管理 (セット管理)

- **対局終了と次戦への移行**:
  - 対局終了時に「次の対局へ」以外に「対局を終了」を選択可能にする。
  - 「対局を終了」を選択した場合、その対局は終了状態となり、以降は参照のみ可能(Read-only)となる。
  - 「次の対局へ」の場合、参加者全員の「合意(準備完了)」により次の対局を開始する。
- **トータル成績管理 (戦績ビュー)**:
  - 対局中および終了後、いつでもメニューから以下の情報を閲覧可能にする。
    - 各対局の得点・順位
    - 現在の合計トータルポイント (オカ・ウマ等の精算後)
    - チップ収支の合計
- **履歴保存・閲覧**:
  - 過去の対局ログを保存・参照可能にする。
  - **個人の対戦履歴**: 各プレイヤーは自身のIDに紐づく過去の対局履歴を閲覧可能にする。

### 8.2 詳細戦績・分析機能 (Analytics)

- **詳細ログ保存**:
  - 1局ごとの詳細な結果（和了者、放銃者、点数移動、リーチ状況など）を保存する。
- **ダッシュボード**:
  - 以下の統計指標を視覚的に表示する。
    - 総合戦績（順位分布、平均順位、対戦数）
    - アガリ率、放銃率、平均打点
    - **リーチ分析**: リーチ率、リーチ後アガリ率、リーチ後放銃率など。
  - 順位推移グラフを表示し、直近の成績トレンドを可視化する。
